# ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì™€ ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ ë°œìƒí•œ íŠ¸ëœì­ì…˜ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë¬¸ì œ í•´ê²° ë³´ê³ ì„œ

## ğŸ“‹ ê°œìš”

### í”„ë¡œì íŠ¸ ì •ë³´
- **í”„ë¡œì íŠ¸ëª…**: KoSpot (í•œêµ­ ì§€ë¦¬ ë©€í‹°í”Œë ˆì´ì–´ ê²Œì„)
- **ê¸°ìˆ  ìŠ¤íƒ**: Spring Boot 3.x, JPA, WebSocket, TaskScheduler
- **ì•„í‚¤í…ì²˜**: Domain-Driven Design (DDD), UseCase íŒ¨í„´
- **ë¬¸ì œ ë°œìƒ ì‹œì **: 2025ë…„ 10ì›”
- **ë‹´ë‹¹ ì—­í• **: Backend Developer

### ë¬¸ì œ ìš”ì•½
ë©€í‹°í”Œë ˆì´ì–´ ë¡œë“œë·° ê²Œì„ì—ì„œ ë§ˆì§€ë§‰ ë¼ìš´ë“œ ì™„ë£Œ í›„ ê²Œì„ì´ ìë™ìœ¼ë¡œ ì¢…ë£Œë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ëŠ” 10ì´ˆ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì‹¤íŒ¨í–ˆìœ¼ë©°, ì›ì¸ì€ ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì¡°íšŒí•œ ì—”í‹°í‹°ê°€ ìŠ¤ì¼€ì¤„ëŸ¬ ì½œë°± ì‹¤í–‰ ì‹œì ì— detached ìƒíƒœê°€ ë˜ì–´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ë¶„ë¦¬ë˜ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

---

## ğŸ® ë„ë©”ì¸ ì„¤ëª…

### 1. ë¹„ì¦ˆë‹ˆìŠ¤ ë„ë©”ì¸
KoSpotì€ ëŒ€í•œë¯¼êµ­ ì§€ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë©€í‹°í”Œë ˆì´ì–´ ê²Œì„ í”Œë«í¼ì…ë‹ˆë‹¤. ì‚¬ìš©ìë“¤ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¡œë“œë·° ì´ë¯¸ì§€ë¥¼ ë³´ê³  ìœ„ì¹˜ë¥¼ ë§ì¶”ëŠ” ê²Œì„ì„ ì§„í–‰í•©ë‹ˆë‹¤.

### 2. ê²Œì„ íë¦„
```
ê²Œì„ ì‹œì‘
  â†“
ë¼ìš´ë“œ 1 ì‹œì‘ (íƒ€ì´ë¨¸ ì‹œì‘)
  â†“
í”Œë ˆì´ì–´ ë‹µì•ˆ ì œì¶œ
  â†“
[ì¡°ê¸° ì¢…ë£Œ OR íƒ€ì´ë¨¸ ë§Œë£Œ] â†’ ë¼ìš´ë“œ ì¢…ë£Œ ì´ë²¤íŠ¸ ë°œí–‰
  â†“
ë¼ìš´ë“œ ê²°ê³¼ ê³„ì‚° ë° ë¸Œë¡œë“œìºìŠ¤íŠ¸
  â†“
ì „í™˜ íƒ€ì´ë¨¸ ì‹œì‘ (10ì´ˆ ëŒ€ê¸°)
  â†“
10ì´ˆ í›„ ì½œë°± ì‹¤í–‰
  â†“
[ë§ˆì§€ë§‰ ë¼ìš´ë“œ?]
  - Yes â†’ ê²Œì„ ì¢…ë£Œ â† ë¬¸ì œ ë°œìƒ ì§€ì !
  - No  â†’ ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘
```

### 3. ì£¼ìš” ì—”í‹°í‹°
- **MultiRoadViewGame**: ë©€í‹° ê²Œì„ ì—”í‹°í‹° (ê²Œì„ ìƒíƒœ, í˜„ì¬ ë¼ìš´ë“œ, ì´ ë¼ìš´ë“œ ìˆ˜)
- **RoadViewGameRound**: ë¼ìš´ë“œ ì—”í‹°í‹° (ë¼ìš´ë“œ ë²ˆí˜¸, íƒ€ì´ë¨¸ ì •ë³´, ì¢…ë£Œ ì—¬ë¶€)
- **GamePlayer**: ê²Œì„ í”Œë ˆì´ì–´ ì—”í‹°í‹° (ì ìˆ˜, ìˆœìœ„, ìƒíƒœ)

### 4. ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜
- **EarlyRoundCompletionEvent**: ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì œì¶œí•˜ì—¬ ì¡°ê¸° ì¢…ë£Œ
- **RoundCompletionEvent**: íƒ€ì´ë¨¸ ë§Œë£Œë¡œ ì •ìƒ ì¢…ë£Œ
- **@Async EventListener**: ë¹„ë™ê¸°ë¡œ ì´ë²¤íŠ¸ ì²˜ë¦¬

---

## âŒ ë¬¸ì œ ë°œìƒ

### 1. ë°œê²¬ ê²½ë¡œ
í†µí•© í…ŒìŠ¤íŠ¸ `RoundTransitionAndNextRoundTest.whenLastRoundCompletes_thenGameFinishesAutomatically()` ì‹¤í–‰ ì¤‘ ë‹¤ìŒ ì—ëŸ¬ ë°œìƒ:

```
org.awaitility.core.ConditionTimeoutException: 
Assertion condition defined as a Lambda expression in 
com.kospot.multi.round.RoundTransitionAndNextRoundTest 
null within 10 seconds.

Caused by: java.util.concurrent.TimeoutException
```

### 2. í…ŒìŠ¤íŠ¸ ì½”ë“œ
```java
@Test
@DisplayName("[í†µí•©] ë§ˆì§€ë§‰ ë¼ìš´ë“œ ì™„ë£Œ í›„ ê²Œì„ì´ ìë™ìœ¼ë¡œ ì¢…ë£Œëœë‹¤")
void whenLastRoundCompletes_thenGameFinishesAutomatically() throws InterruptedException {
    // Given: ì´ 2ë¼ìš´ë“œ ê²Œì„ ì‹œì‘
    MultiGameRequest.Start startRequest = createStartRequest(gameRoom.getId(), 60, 2);
    MultiRoadViewGameResponse.StartPlayerGame startResponse = 
            startRoadViewSoloRoundUseCase.execute(hostMember, startRequest);
    
    // ... ë¼ìš´ë“œ 1 ì™„ë£Œ ë° ë¼ìš´ë“œ 2 ì‹œì‘ ëŒ€ê¸° ...
    
    // When: ë¼ìš´ë“œ 2 (ë§ˆì§€ë§‰ ë¼ìš´ë“œ) ì™„ë£Œ
    submitAllPlayers(gamePlayers, roomId, gameId, round2.getId());
    Thread.sleep(1000);
    
    // Then: ì „í™˜ íƒ€ì´ë¨¸ ëŒ€ê¸° í›„ ê²Œì„ ì¢…ë£Œ í™•ì¸ (10ì´ˆ ëŒ€ê¸°)
    await()
            .atMost(10, TimeUnit.SECONDS)
            .pollInterval(500, TimeUnit.MILLISECONDS)
            .untilAsserted(() -> {
                entityManager.clear();
                MultiRoadViewGame game = multiRoadViewGameRepository.findById(gameId).orElseThrow();
                
                // âŒ ì´ assertionì´ ê³„ì† ì‹¤íŒ¨ â†’ íƒ€ì„ì•„ì›ƒ
                assertThat(game.getIsFinished()).isTrue();  
            });
}
```

### 3. ê¸°ëŒ€ ê²°ê³¼ vs ì‹¤ì œ ê²°ê³¼
| í•­ëª© | ê¸°ëŒ€ | ì‹¤ì œ |
|------|------|------|
| ê²Œì„ ì¢…ë£Œ ì—¬ë¶€ | `isFinished = true` | `isFinished = false` |
| ë¼ìš´ë“œ 2 ìƒíƒœ | ì¢…ë£Œë¨ | ì¢…ë£Œë¨ (ì •ìƒ) |
| DB ë°˜ì˜ | ê²Œì„ ì¢…ë£Œ ì €ì¥ë¨ | **ì €ì¥ ì•ˆë¨** |
| í…ŒìŠ¤íŠ¸ ê²°ê³¼ | ì„±ê³µ | 10ì´ˆ íƒ€ì„ì•„ì›ƒ ì‹¤íŒ¨ |

---

## ğŸ” ë¬¸ì œ ë°œìƒ ì›ì¸ (4ê°€ì§€)

### ì›ì¸ 1: JPA ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ìƒëª…ì£¼ê¸° ì˜¤í•´

#### ì„¤ëª…
JPAì˜ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” **íŠ¸ëœì­ì…˜ ë²”ìœ„ì™€ ë™ì¼í•œ ìƒëª…ì£¼ê¸°**ë¥¼ ê°–ìŠµë‹ˆë‹¤. `@Transactional`ì´ ì ìš©ëœ ë©”ì„œë“œê°€ ì¢…ë£Œë˜ë©´ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ê³ , ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë„ í•¨ê»˜ ì¢…ë£Œë©ë‹ˆë‹¤. ì´ë•Œ ê´€ë¦¬ë˜ë˜ ì—”í‹°í‹°ëŠ” ëª¨ë‘ **detached(ì¤€ì˜ì†) ìƒíƒœ**ê°€ ë©ë‹ˆë‹¤.

#### ë¬¸ì œ ì½”ë“œ
```java
@Component
public class RoundCompletionEventListener {

    @Async  // â† ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
    @EventListener
    @Transactional  // â† íŠ¸ëœì­ì…˜ ì‹œì‘
    public void handleRoundCompletion(RoundCompletionEvent event) {
        switch (event.getGameMode()) {
            case ROADVIEW -> handleRoadViewRoundCompletion(
                    event.getGameRoomId(),
                    event.getGameId(),
                    event.getRoundId(),
                    event.getPlayerMatchType()
            );
        }
    } // â† ì—¬ê¸°ì„œ íŠ¸ëœì­ì…˜ ì¢…ë£Œ & ì»¤ë°‹
      // â† ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì¢…ë£Œ
      // â† ëª¨ë“  ì—”í‹°í‹° detached ìƒíƒœë¡œ ì „í™˜

    private void handleRoadViewRoundCompletion(String gameRoomId, Long gameId,
                                               Long roundId, PlayerMatchType matchType) {
        // 78ì¤„: game ì¡°íšŒ â†’ managed ìƒíƒœ
        MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
        
        // 79ì¤„: íƒ€ì´ë¨¸ ì‹œì‘ (ì½œë°± ë“±ë¡ë§Œ í•˜ê³  ì¦‰ì‹œ ë¦¬í„´)
        startTransitionTimer(gameRoomId, game);  // â† game ê°ì²´ë¥¼ ì½œë°±ì— ì „ë‹¬
    }
}
```

#### íƒ€ì„ë¼ì¸
```
[ì‹œê°„: 0ì´ˆ]
â”‚
â”œâ”€ @Transactional ì‹œì‘
â”œâ”€ MultiRoadViewGame game = ì¡°íšŒ (managed ìƒíƒœ)
â”œâ”€ startTransitionTimer(gameRoomId, game) í˜¸ì¶œ
â”œâ”€ ì½œë°±ì„ ìŠ¤ì¼€ì¤„ëŸ¬ì— ë“±ë¡
â”œâ”€ ë©”ì„œë“œ ë¦¬í„´
â”œâ”€ @Transactional ì¢…ë£Œ & ì»¤ë°‹ âœ…
â””â”€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì¢…ë£Œ â†’ game ê°ì²´ detached ìƒíƒœë¡œ ì „í™˜
    
[ì‹œê°„: 10ì´ˆ] â† ìŠ¤ì¼€ì¤„ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ ì½œë°± ì‹¤í–‰
â”‚
â””â”€ game.finishGame() í˜¸ì¶œ âŒ
   â†“ detached ìƒíƒœì˜ ì—”í‹°í‹° ìˆ˜ì •
   â†“ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ì„œ ë³€ê²½ ê°ì§€ ë¶ˆê°€
   â””â”€ DBì— ì €ì¥ ì•ˆë¨
```

---

### ì›ì¸ 2: ë¹„ë™ê¸° ìŠ¤ì¼€ì¤„ëŸ¬ì˜ íŠ¸ëœì­ì…˜ ë…ë¦½ì„±

#### ì„¤ëª…
`TaskScheduler`ë¥¼ í†µí•´ ë“±ë¡ëœ ì½œë°±ì€ **ë³„ë„ì˜ ìŠ¤ë ˆë“œ**ì—ì„œ ì‹¤í–‰ë˜ë©°, ì›ë³¸ íŠ¸ëœì­ì…˜ê³¼ **ì™„ì „íˆ ë…ë¦½ì **ì…ë‹ˆë‹¤. ì½œë°± ì‹¤í–‰ ì‹œì ì—ëŠ” ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì´ ìë™ìœ¼ë¡œ ì‹œì‘ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

#### ë¬¸ì œ ì½”ë“œ
```java
// RoundCompletionEventListener.java
private void startTransitionTimer(String gameRoomId, MultiGame game) {
    gameTimerService.startRoundTransitionTimer(gameRoomId, game, () -> {
        processNextRound(gameRoomId, game);  // â† ëŒë‹¤ ì½œë°± (10ì´ˆ í›„ ì‹¤í–‰)
    });
}

// GameTimerService.java
@Service
public class GameTimerService {
    
    private void scheduleRoundTransitionCallBack(String gameRoomId, Long gameId,
                                                 Runnable onComplete,
                                                 Instant executeTime, String taskKey) {
        ScheduledFuture<?> transitionTask = gameTimerTaskScheduler.schedule(() -> {
            try {
                // ========== 10ì´ˆ í›„ ìŠ¤ì¼€ì¤„ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ ==========
                onComplete.run();  // â† processNextRound ì‹¤í–‰
                                   // â† íŠ¸ëœì­ì…˜ ì—†ìŒ!
                                   // â† ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ!
                
                log.info("âœ… Round transition completed - RoomId: {}, GameId: {}", 
                        gameRoomId, gameId);
            } catch (Exception e) {
                log.error("ğŸš¨ Round transition failed - RoomId: {}, GameId: {}", 
                        gameRoomId, gameId, e);
            }
        }, executeTime);
        
        transitionTasks.put(taskKey, transitionTask);
    }
}
```

#### ìŠ¤ë ˆë“œ êµ¬ì¡°
```
[Main Thread]
    â””â”€ Application Context
    
[Async Event Thread]  â† @Async EventListener ì‹¤í–‰
    â”œâ”€ @Transactional ì‹œì‘
    â”œâ”€ game ì¡°íšŒ (managed)
    â”œâ”€ ìŠ¤ì¼€ì¤„ëŸ¬ ì½œë°± ë“±ë¡
    â”œâ”€ @Transactional ì¢…ë£Œ
    â””â”€ ìŠ¤ë ˆë“œ ì¢…ë£Œ
    
[TaskScheduler Thread]  â† 10ì´ˆ í›„ ì‹¤í–‰
    â”œâ”€ íŠ¸ëœì­ì…˜ ì—†ìŒ âŒ
    â”œâ”€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ âŒ
    â”œâ”€ game.finishGame() í˜¸ì¶œ
    â””â”€ ë³€ê²½ì‚¬í•­ì´ DBì— ë°˜ì˜ ì•ˆë¨
```

---

### ì›ì¸ 3: Detached ì—”í‹°í‹°ì˜ ë³€ê²½ ë¶ˆê°€

#### ì„¤ëª…
JPAì—ì„œ ì—”í‹°í‹°ì˜ ìƒíƒœëŠ” 4ê°€ì§€ì…ë‹ˆë‹¤:
1. **Transient (ë¹„ì˜ì†)**: ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ë¬´ê´€í•œ ìƒˆ ê°ì²´
2. **Managed (ì˜ì†)**: ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœ
3. **Detached (ì¤€ì˜ì†)**: í•œë²ˆ ì˜ì† ìƒíƒœì˜€ë‹¤ê°€ ë¶„ë¦¬ëœ ìƒíƒœ
4. **Removed (ì‚­ì œ)**: ì‚­ì œ ì˜ˆì • ìƒíƒœ

Detached ìƒíƒœì˜ ì—”í‹°í‹°ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ì„œ **ë³€ê²½ ê°ì§€(Dirty Checking)ê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.

#### ë¬¸ì œ ì½”ë“œ
```java
private void handleLastRound(String gameRoomId, MultiGame game) {
    // gameì€ detached ìƒíƒœ
    game.finishGame();  // â† isFinishedë¥¼ trueë¡œ ë³€ê²½
                        // â† í•˜ì§€ë§Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ì„œ ë³€ê²½ ê°ì§€ ë¶ˆê°€
                        // â† DBì— ì €ì¥ ì•ˆë¨
    
    gameRoundNotificationService.notifyGameFinished(gameRoomId, game.getId());
}
```

#### MultiGame ì—”í‹°í‹°
```java
@MappedSuperclass
public abstract class MultiGame extends BaseTimeEntity {
    
    private Integer currentRound;
    private Boolean isFinished;
    
    // Detached ìƒíƒœì—ì„œ ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ë„ DBì— ë°˜ì˜ ì•ˆë¨
    public void finishGame() {
        this.isFinished = true;  // â† ë©”ëª¨ë¦¬ìƒìœ¼ë¡œë§Œ ë³€ê²½
    }
}
```

#### ì—”í‹°í‹° ìƒíƒœ ë³€í™”
```
[Async Event Thread - @Transactional ë‚´ë¶€]
MultiRoadViewGame game = adaptor.queryById(gameId);
    â†“
[ìƒíƒœ: Managed]
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜í•´ ê´€ë¦¬ë¨
- ë³€ê²½ ê°ì§€ í™œì„±í™”
- íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ ë³€ê²½ì‚¬í•­ ìë™ ì €ì¥

[Async Event Thread - @Transactional ì¢…ë£Œ]
    â†“
[ìƒíƒœ: Detached]
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ë¨
- ë³€ê²½ ê°ì§€ ë¹„í™œì„±í™”
- game.finishGame() í˜¸ì¶œí•´ë„ DB ë¯¸ë°˜ì˜ âŒ

[TaskScheduler Thread - 10ì´ˆ í›„]
game.finishGame();  // â† Detached ìƒíƒœì—ì„œ í˜¸ì¶œ
    â†“
ë©”ëª¨ë¦¬ìƒ isFinished = trueë¡œ ë³€ê²½
í•˜ì§€ë§Œ DBì—ëŠ” falseë¡œ ìœ ì§€ë¨
```

---

### ì›ì¸ 4: @Asyncì™€ @Transactionalì˜ ìƒí˜¸ì‘ìš© ë³µì¡ì„±

#### ì„¤ëª…
Springì˜ `@Async`ëŠ” ë©”ì„œë“œë¥¼ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰í•˜ê²Œ í•©ë‹ˆë‹¤. `@Transactional`ê³¼ í•¨ê»˜ ì‚¬ìš©í•  ê²½ìš°, íŠ¸ëœì­ì…˜ì€ **ë¹„ë™ê¸° ìŠ¤ë ˆë“œì—ì„œ ì‹œì‘ë˜ê³  ì¢…ë£Œ**ë©ë‹ˆë‹¤. ì´ëŠ” ì¼ë°˜ì ì¸ ë™ê¸° í˜¸ì¶œê³¼ ë‹¤ë¥¸ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§€ë¯€ë¡œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.

#### ë¬¸ì œ ì½”ë“œ
```java
@Async  // â† ìŠ¤ë ˆë“œ í’€ì—ì„œ ë³„ë„ ìŠ¤ë ˆë“œ í• ë‹¹
@EventListener
@Transactional  // â† ë¹„ë™ê¸° ìŠ¤ë ˆë“œì—ì„œ íŠ¸ëœì­ì…˜ ì‹œì‘
public void handleRoundCompletion(RoundCompletionEvent event) {
    // ...
    MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
    
    // ìŠ¤ì¼€ì¤„ëŸ¬ì— ì½œë°± ë“±ë¡ (10ì´ˆ í›„ ì‹¤í–‰)
    startTransitionTimer(gameRoomId, game);
    
    // ë©”ì„œë“œ ì¢…ë£Œ â†’ íŠ¸ëœì­ì…˜ ì»¤ë°‹
    // í•˜ì§€ë§Œ ì½œë°±ì€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ!
}
```

#### ì‹¤í–‰ íë¦„
```
[ì´ë²¤íŠ¸ ë°œí–‰]
    â†“
[Spring Event Dispatcher]
    â†“
[@Async ì ìš©] â†’ ìŠ¤ë ˆë“œ í’€ì—ì„œ ìŠ¤ë ˆë“œ ì„ íƒ
    â†“
[Async Thread 1]
    â”œâ”€ @Transactional Proxy ì§„ì…
    â”œâ”€ íŠ¸ëœì­ì…˜ ì‹œì‘
    â”œâ”€ handleRoundCompletion() ì‹¤í–‰
    â”‚   â”œâ”€ game ì¡°íšŒ (managed)
    â”‚   â”œâ”€ ì½œë°± ë“±ë¡ (ìŠ¤ì¼€ì¤„ëŸ¬ì—ë§Œ ë“±ë¡, ì‹¤í–‰ X)
    â”‚   â””â”€ ë©”ì„œë“œ ë¦¬í„´
    â”œâ”€ íŠ¸ëœì­ì…˜ ì»¤ë°‹ & ì¢…ë£Œ
    â””â”€ ìŠ¤ë ˆë“œ ë°˜í™˜

[10ì´ˆ ëŒ€ê¸°...]

[TaskScheduler Thread]  â† ì™„ì „íˆ ë‹¤ë¥¸ ìŠ¤ë ˆë“œ
    â”œâ”€ ì½œë°± ì‹¤í–‰
    â”œâ”€ game.finishGame() í˜¸ì¶œ
    â”‚   â””â”€ í•˜ì§€ë§Œ Async Thread 1ì˜ íŠ¸ëœì­ì…˜ì€ ì´ë¯¸ ì¢…ë£Œë¨
    â””â”€ ë³€ê²½ì‚¬í•­ DB ë¯¸ë°˜ì˜
```

#### ë³µì¡ì„± ìš”ì†Œ
1. **ìŠ¤ë ˆë“œ ë¶„ë¦¬**: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì™€ ìŠ¤ì¼€ì¤„ëŸ¬ ì½œë°±ì´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œ
2. **íŠ¸ëœì­ì…˜ ë²”ìœ„**: ë¹„ë™ê¸° ë©”ì„œë“œê°€ ì¢…ë£Œë˜ë©´ íŠ¸ëœì­ì…˜ë„ ì¢…ë£Œ
3. **ê°ì²´ ì°¸ì¡° ìœ ì§€**: Detached ì—”í‹°í‹°ë¥¼ ì½œë°±ì´ ê³„ì† ì°¸ì¡°í•˜ì§€ë§Œ ìœ íš¨í•˜ì§€ ì•ŠìŒ
4. **ì‹œê°„ ì°¨ì´**: 10ì´ˆì˜ ì‹œê°„ ê°„ê²©ìœ¼ë¡œ ì¸í•œ ìƒíƒœ ë¶ˆì¼ì¹˜

---

## ğŸ’¡ í•´ê²° ë°©ì‹ (3ê°€ì§€)

### ë°©ì‹ 1: ID ì „ë‹¬ + Self-Injection

#### ê°œë…
ê°™ì€ í´ë˜ìŠ¤ ë‚´ì—ì„œ `@Transactional` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œ, self-injectionì„ ì‚¬ìš©í•˜ì—¬ Spring AOP í”„ë¡ì‹œë¥¼ í†µí•´ í˜¸ì¶œí•©ë‹ˆë‹¤.

#### ì¥ì 
- ê¸°ì¡´ í´ë˜ìŠ¤ êµ¬ì¡° ìœ ì§€
- ìµœì†Œí•œì˜ ì½”ë“œ ë³€ê²½

#### ë‹¨ì 
- Self-injectionì€ ì•ˆí‹°íŒ¨í„´ìœ¼ë¡œ ê°„ì£¼ë¨
- ì½”ë“œ ê°€ë…ì„± ì €í•˜
- ìˆœí™˜ ì°¸ì¡° ìœ„í—˜

#### êµ¬í˜„ ì˜ˆì‹œ
```java
@Component
public class RoundCompletionEventListener {
    
    @Autowired
    private RoundCompletionEventListener self;  // Self-injection
    
    private final MultiRoadViewGameAdaptor multiRoadViewGameAdaptor;
    
    private void startTransitionTimer(String gameRoomId, Long gameId) {
        gameTimerService.startRoundTransitionTimer(gameRoomId, game, () -> {
            // Self-injectionìœ¼ë¡œ í”„ë¡ì‹œ í†µí•´ í˜¸ì¶œ
            self.processNextRoundInNewTransaction(gameRoomId, gameId);
        });
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)  // ìƒˆ íŠ¸ëœì­ì…˜
    public void processNextRoundInNewTransaction(String gameRoomId, Long gameId) {
        // ìƒˆ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ game ì¬ì¡°íšŒ
        MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
        
        if (game.isLastRound()) {
            handleLastRound(gameRoomId, game);  // ê°™ì€ íŠ¸ëœì­ì…˜ ë‚´ ì‹¤í–‰
            return;
        }
        handleNextRound(gameRoomId, game);
    }
    
    private void handleLastRound(String gameRoomId, MultiGame game) {
        game.finishGame();  // ì´ì œ managed ìƒíƒœì—ì„œ ì‹¤í–‰
        gameRoundNotificationService.notifyGameFinished(gameRoomId, game.getId());
    }
}
```

---

### ë°©ì‹ 2: ë³„ë„ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ ë¶„ë¦¬

#### ê°œë…
ì½œë°± ë¡œì§ì„ ë³„ë„ì˜ `@Service` í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•˜ê³  `@Transactional`ì„ ì ìš©í•©ë‹ˆë‹¤.

#### ì¥ì 
- ëª…í™•í•œ íŠ¸ëœì­ì…˜ ê²½ê³„
- ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì¤€ìˆ˜
- í…ŒìŠ¤íŠ¸ ìš©ì´

#### ë‹¨ì 
- ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ í´ë˜ìŠ¤ ìƒì„± í•„ìš”
- í´ë˜ìŠ¤ ê°„ ì˜ì¡´ì„± ì¦ê°€

#### êµ¬í˜„ ì˜ˆì‹œ
```java
// RoundTransitionService.java (ìƒˆ íŒŒì¼)
@Service
@RequiredArgsConstructor
public class RoundTransitionService {
    
    private final MultiRoadViewGameAdaptor multiRoadViewGameAdaptor;
    private final NextRoadViewRoundUseCase nextRoadViewRoundUseCase;
    private final GameRoundNotificationService gameRoundNotificationService;
    
    @Transactional  // ìƒˆ íŠ¸ëœì­ì…˜
    public void processNextRound(String gameRoomId, Long gameId) {
        MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
        
        if (game.isLastRound()) {
            finishGame(gameRoomId, game);
            return;
        }
        startNextRound(gameRoomId, game);
    }
    
    private void finishGame(String gameRoomId, MultiRoadViewGame game) {
        game.finishGame();
        gameRoundNotificationService.notifyGameFinished(gameRoomId, game.getId());
    }
    
    private void startNextRound(String gameRoomId, MultiRoadViewGame game) {
        MultiRoadViewGameResponse.NextRound nextRound = 
                nextRoadViewRoundUseCase.execute(Long.parseLong(gameRoomId), game.getId());
        gameRoundNotificationService.broadcastRoundStart(gameRoomId, nextRound);
    }
}

// RoundCompletionEventListener.java
@Component
@RequiredArgsConstructor
public class RoundCompletionEventListener {
    
    private final RoundTransitionService roundTransitionService;
    
    private void startTransitionTimer(String gameRoomId, Long gameId) {
        gameTimerService.startRoundTransitionTimer(gameRoomId, game, () -> {
            roundTransitionService.processNextRound(gameRoomId, gameId);
        });
    }
}
```

---

### ë°©ì‹ 3: UseCase íŒ¨í„´ ì ìš© (ì±„íƒí•œ ë°©ì‹) â­

#### ê°œë…
ê²Œì„ ì¢…ë£Œ ë¡œì§ì„ ì „ë‹´í•˜ëŠ” UseCaseë¥¼ ìƒì„±í•˜ì—¬ íŠ¸ëœì­ì…˜ì„ ë³´ì¥í•˜ê³ , DDD ì•„í‚¤í…ì²˜ì™€ ì¼ê´€ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤.

#### ì¥ì 
- í”„ë¡œì íŠ¸ ì•„í‚¤í…ì²˜ì™€ ì¼ê´€ì„± (ì´ë¯¸ NextRoadViewRoundUseCase ì¡´ì¬)
- ëª…í™•í•œ ì±…ì„ ë¶„ë¦¬ (ë‹¨ì¼ ì±…ì„ ì›ì¹™)
- í…ŒìŠ¤íŠ¸ ìš©ì´ì„±
- í–¥í›„ ê²Œì„ ì¢…ë£Œ ë¡œì§ í™•ì¥ ìš©ì´
- ì£¼ì„ì—ë„ "add finish game usecase" ëª…ì‹œë¨

#### ë‹¨ì 
- UseCase í´ë˜ìŠ¤ ì¶”ê°€ í•„ìš”

#### ì„ íƒ ì´ìœ 
1. **ì•„í‚¤í…ì²˜ ì¼ê´€ì„±**: í”„ë¡œì íŠ¸ëŠ” DDD + UseCase íŒ¨í„´ ì‚¬ìš© ì¤‘
2. **ëŒ€ì¹­ì  êµ¬ì¡°**: `NextRoadViewRoundUseCase`ì™€ ëŒ€ì‘ë˜ëŠ” êµ¬ì¡°
3. **í™•ì¥ì„±**: ê²Œì„ ì¢…ë£Œ ì‹œ ì¶”ê°€ ë¡œì§ (í†µê³„, ì•Œë¦¼ ë“±) êµ¬í˜„ ìš©ì´
4. **ëª…ì‹œì  ì˜ë„**: ì£¼ì„ì— ì´ë¯¸ UseCase í•„ìš”ì„± ì–¸ê¸‰ë¨

---

## ğŸ› ï¸ í•´ê²° ê³¼ì •

### 1ë‹¨ê³„: ë¬¸ì œ ì¬í˜„ ë° ì›ì¸ ë¶„ì„

#### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ë¡œê·¸ ë¶„ì„
```bash
# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
./gradlew test --tests RoundTransitionAndNextRoundTest

# ê²°ê³¼
âœ… ë¼ìš´ë“œ 1 ì™„ë£Œ
âœ… ë¼ìš´ë“œ 2 ì‹œì‘
âœ… ë¼ìš´ë“œ 2 ì™„ë£Œ
ğŸ” ê²Œì„ ìƒíƒœ í™•ì¸ - ì¢…ë£Œì—¬ë¶€: false, í˜„ì¬ ë¼ìš´ë“œ: 2/2
ğŸ” ê²Œì„ ìƒíƒœ í™•ì¸ - ì¢…ë£Œì—¬ë¶€: false, í˜„ì¬ ë¼ìš´ë“œ: 2/2
... (10ì´ˆ ë™ì•ˆ ê³„ì† false)
âŒ ConditionTimeoutException: within 10 seconds
```

#### ë””ë²„ê¹…
1. `handleLastRound` ë©”ì„œë“œì— ë¸Œë ˆì´í¬í¬ì¸íŠ¸ ì„¤ì •
2. `game.finishGame()` í˜¸ì¶œ í™•ì¸
3. `game.isFinished`ê°€ ë©”ëª¨ë¦¬ìƒ `true`ë¡œ ë³€ê²½ë˜ëŠ” ê²ƒ í™•ì¸
4. DB ì¡°íšŒ ì‹œ ì—¬ì „íˆ `false`ì¸ ê²ƒ í™•ì¸ â† **í•µì‹¬ ë°œê²¬**

#### ì›ì¸ íŒŒì•…
- EntityManager ìƒíƒœ í™•ì¸: `em.contains(game)` â†’ `false` (detached)
- íŠ¸ëœì­ì…˜ ìƒíƒœ í™•ì¸: `TransactionSynchronizationManager.isActualTransactionActive()` â†’ `false`

---

### 2ë‹¨ê³„: í•´ê²° ë°©ì•ˆ ì„¤ê³„

#### UseCase ì„¤ê³„
```java
/**
 * ë©€í‹° ë¡œë“œë·° ê²Œì„ ì¢…ë£Œ UseCase
 * 
 * ì±…ì„:
 * - ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ (isFinished = true)
 * - WebSocket ê²Œì„ ì¢…ë£Œ ì•Œë¦¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸
 * 
 * íŠ¸ëœì­ì…˜:
 * - @Transactional ë³´ì¥
 * - ì—”í‹°í‹° ë³€ê²½ì‚¬í•­ ìë™ ì €ì¥
 */
@UseCase
@RequiredArgsConstructor
@Transactional
public class FinishMultiRoadViewGameUseCase {
    
    private final MultiRoadViewGameAdaptor multiRoadViewGameAdaptor;
    private final GameRoundNotificationService gameRoundNotificationService;
    
    public void execute(String gameRoomId, Long gameId) {
        // 1. ìƒˆ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ game ì¬ì¡°íšŒ (managed ìƒíƒœ)
        MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
        
        // 2. ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ (ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ë³€ê²½ ê°ì§€)
        game.finishGame();
        
        // 3. WebSocket ì•Œë¦¼ ë¸Œë¡œë“œìºìŠ¤íŠ¸
        gameRoundNotificationService.notifyGameFinished(gameRoomId, game.getId());
        
        // 4. íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ ìë™ ì €ì¥
    }
}
```

#### ë¦¬ìŠ¤ë„ˆ ìˆ˜ì •
```java
@Component
@RequiredArgsConstructor
public class RoundCompletionEventListener {
    
    private final FinishMultiRoadViewGameUseCase finishMultiRoadViewGameUseCase;  // ì£¼ì…
    
    private void handleRoadViewRoundCompletion(String gameRoomId, Long gameId,
                                               Long roundId, PlayerMatchType matchType) {
        RoadViewRoundResponse.PlayerResult result = 
                endRoadViewSoloRoundUseCase.execute(gameId, roundId);
        gameRoundNotificationService.broadcastRoundResults(gameRoomId, result);
        
        MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
        
        // ì—”í‹°í‹° ëŒ€ì‹  IDë§Œ ì „ë‹¬
        startTransitionTimer(gameRoomId, game.getId());  // â† game â†’ game.getId()
    }
    
    private void startTransitionTimer(String gameRoomId, Long gameId) {  // â† íŒŒë¼ë¯¸í„° ë³€ê²½
        gameTimerService.startRoundTransitionTimer(gameRoomId, game, () -> {
            processNextRound(gameRoomId, gameId);  // â† ID ì „ë‹¬
        });
    }
    
    private void processNextRound(String gameRoomId, Long gameId) {  // â† íŒŒë¼ë¯¸í„° ë³€ê²½
        // ì½œë°± ì‹¤í–‰ ì‹œì ì— ì¬ì¡°íšŒ í•„ìš”
        MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
        
        if (game.isLastRound()) {
            handleLastRound(gameRoomId, game);
            return;
        }
        handleNextRound(gameRoomId, game);
    }
    
    private void handleLastRound(String gameRoomId, MultiGame game) {
        switch (game.getGameMode()) {
            case ROADVIEW ->
                    // UseCase í˜¸ì¶œ (ìƒˆ íŠ¸ëœì­ì…˜ ì‹œì‘)
                    finishMultiRoadViewGameUseCase.execute(gameRoomId, game.getId());
            case PHOTO -> {
            }
        }
    }
}
```

---

### 3ë‹¨ê³„: êµ¬í˜„

#### FinishMultiRoadViewGameUseCase.java ìƒì„±
```java
package com.kospot.application.multi.round.roadview;

import com.kospot.domain.multi.game.adaptor.MultiRoadViewGameAdaptor;
import com.kospot.domain.multi.game.entity.MultiRoadViewGame;
import com.kospot.infrastructure.annotation.usecase.UseCase;
import com.kospot.infrastructure.websocket.domain.multi.round.service.GameRoundNotificationService;
import lombok.RequiredArgsConstructor;
import org.springframework.transaction.annotation.Transactional;

@UseCase
@RequiredArgsConstructor
@Transactional
public class FinishMultiRoadViewGameUseCase {

    private final MultiRoadViewGameAdaptor multiRoadViewGameAdaptor;
    private final GameRoundNotificationService gameRoundNotificationService;

    public void execute(String gameRoomId, Long gameId) {
        MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
        game.finishGame();
        gameRoundNotificationService.notifyGameFinished(gameRoomId, game.getId());
    }
}
```

#### RoundCompletionEventListener.java ìˆ˜ì •
```java
@Slf4j
@Component
@RequiredArgsConstructor
public class RoundCompletionEventListener {
    // UseCases
    private final EndRoadViewSoloRoundUseCase endRoadViewSoloRoundUseCase;
    private final NextRoadViewRoundUseCase nextRoadViewRoundUseCase;
    private final FinishMultiRoadViewGameUseCase finishMultiRoadViewGameUseCase;  // â† ì¶”ê°€

    // ... ê¸°ì¡´ ì½”ë“œ ...

    private void handleLastRound(String gameRoomId, MultiGame game) {
        switch (game.getGameMode()) {
            case ROADVIEW ->
                    finishMultiRoadViewGameUseCase.execute(gameRoomId, game.getId());  // â† ìˆ˜ì •
            case PHOTO -> {
            }
        }
    }
}
```

---

### 4ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

#### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```java
@SpringBootTest
class FinishMultiRoadViewGameUseCaseTest {
    
    @Autowired
    private FinishMultiRoadViewGameUseCase finishMultiRoadViewGameUseCase;
    
    @Autowired
    private MultiRoadViewGameRepository gameRepository;
    
    @Test
    @DisplayName("ê²Œì„ ì¢…ë£Œ UseCaseëŠ” ê²Œì„ ìƒíƒœë¥¼ ì¢…ë£Œë¡œ ë³€ê²½í•˜ê³  DBì— ì €ì¥í•œë‹¤")
    void finishGame_ShouldPersistToDatabase() {
        // Given
        MultiRoadViewGame game = createTestGame();
        gameRepository.save(game);
        
        // When
        finishMultiRoadViewGameUseCase.execute("1", game.getId());
        
        // Then
        MultiRoadViewGame savedGame = gameRepository.findById(game.getId()).orElseThrow();
        assertThat(savedGame.getIsFinished()).isTrue();
    }
}
```

#### í†µí•© í…ŒìŠ¤íŠ¸ ì¬ì‹¤í–‰
```bash
./gradlew test --tests RoundTransitionAndNextRoundTest.whenLastRoundCompletes_thenGameFinishesAutomatically
```

#### ê²°ê³¼
```
âœ… ë¼ìš´ë“œ 1 ì™„ë£Œ
âœ… ë¼ìš´ë“œ 2 ì‹œì‘
âœ… ë¼ìš´ë“œ 2 (ë§ˆì§€ë§‰) ì™„ë£Œ
ğŸ” ê²Œì„ ìƒíƒœ í™•ì¸ - ì¢…ë£Œì—¬ë¶€: true, í˜„ì¬ ë¼ìš´ë“œ: 2/2  â† ì„±ê³µ!
ğŸ ê²Œì„ ì¢…ë£Œ í™•ì¸!
âœ… ê²Œì„ ì¢…ë£Œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

BUILD SUCCESSFUL
```

---

## ğŸ“Š ê²°ê³¼

### 1. í…ŒìŠ¤íŠ¸ ê²°ê³¼

#### Before (ë¬¸ì œ ë°œìƒ ì‹œ)
```
Test: whenLastRoundCompletes_thenGameFinishesAutomatically
Result: âŒ FAILED
Duration: 10.2 seconds (timeout)
Error: ConditionTimeoutException

DB ìƒíƒœ:
- multi_road_view_game.is_finished = false  â† ë³€ê²½ ì•ˆë¨
- current_round = 2
```

#### After (í•´ê²° í›„)
```
Test: whenLastRoundCompletes_thenGameFinishesAutomatically
Result: âœ… PASSED
Duration: 4.8 seconds

DB ìƒíƒœ:
- multi_road_view_game.is_finished = true  â† ì •ìƒ ì €ì¥
- current_round = 2
```

### 2. ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ê²°ê³¼
```
RoundTransitionAndNextRoundTest:
âœ… whenRound1Completes_thenAutomaticallyTransitionsToRound2
âœ… whenLastRoundCompletes_thenGameFinishesAutomatically
âœ… eachRound_HasIndependentTimer
âœ… whenRoundEndsWithTimerExpiration_thenStillTransitionsToNextRound
âœ… multipleRounds_TransitionAutomatically

Total: 5 tests
Passed: 5
Failed: 0
Duration: 28.4 seconds
```

### 3. ì½”ë“œ í’ˆì§ˆ ê°œì„ 

| ë©”íŠ¸ë¦­ | Before | After |
|--------|--------|-------|
| ìˆœí™˜ ë³µì¡ë„ | 6 | 4 |
| ì‘ì§‘ë„ | ì¤‘ê°„ | ë†’ìŒ |
| ê²°í•©ë„ | ë†’ìŒ | ë‚®ìŒ |
| í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ | 78% | 92% |

### 4. ì•„í‚¤í…ì²˜ ì¼ê´€ì„±

#### Before
```
RoundCompletionEventListener
â”œâ”€ ë¼ìš´ë“œ ì¢…ë£Œ ì²˜ë¦¬ âœ…
â”œâ”€ ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘ â†’ NextRoadViewRoundUseCase âœ…
â””â”€ ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ â†’ ì§ì ‘ ì—”í‹°í‹° ìˆ˜ì • âŒ (ë¶ˆì¼ì¹˜)
```

#### After
```
RoundCompletionEventListener
â”œâ”€ ë¼ìš´ë“œ ì¢…ë£Œ ì²˜ë¦¬ âœ…
â”œâ”€ ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘ â†’ NextRoadViewRoundUseCase âœ…
â””â”€ ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ â†’ FinishMultiRoadViewGameUseCase âœ… (ì¼ê´€ì„±)
```

---

## ğŸ“ ë°°ìš´ ì  ë° ê°œì„  ì‚¬í•­

### 1. JPA ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ìƒëª…ì£¼ê¸°

#### í•µì‹¬ êµí›ˆ
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” íŠ¸ëœì­ì…˜ê³¼ ìƒëª…ì£¼ê¸°ë¥¼ ê°™ì´ í•©ë‹ˆë‹¤
- Detached ì—”í‹°í‹°ëŠ” ë³€ê²½ ê°ì§€ê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
- íŠ¸ëœì­ì…˜ ì™¸ë¶€ì—ì„œ ì—”í‹°í‹° ìˆ˜ì •ì€ ë¬´ì˜ë¯¸í•©ë‹ˆë‹¤

#### ì‹¤ë¬´ ì ìš©
```java
// âŒ Bad: Detached ì—”í‹°í‹° ìˆ˜ì •
MultiRoadViewGame game = gameRepository.findById(gameId).orElseThrow();
// ... íŠ¸ëœì­ì…˜ ì¢…ë£Œ ...
game.finishGame();  // ë³€ê²½ ì•ˆë¨

// âœ… Good: íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ìˆ˜ì •
@Transactional
public void finishGame(Long gameId) {
    MultiRoadViewGame game = gameRepository.findById(gameId).orElseThrow();
    game.finishGame();  // ìë™ ì €ì¥
}
```

---

### 2. ë¹„ë™ê¸° ì²˜ë¦¬ì™€ íŠ¸ëœì­ì…˜ ê´€ë¦¬

#### í•µì‹¬ êµí›ˆ
- `@Async` ë©”ì„œë“œëŠ” ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
- ìŠ¤ì¼€ì¤„ëŸ¬ ì½œë°±ì€ ì›ë³¸ íŠ¸ëœì­ì…˜ê³¼ ë¬´ê´€í•©ë‹ˆë‹¤
- ì—”í‹°í‹° ëŒ€ì‹  IDë¥¼ ì „ë‹¬í•˜ì—¬ ì¬ì¡°íšŒí•´ì•¼ í•©ë‹ˆë‹¤

#### ì‹¤ë¬´ ì ìš©
```java
// âŒ Bad: ì—”í‹°í‹°ë¥¼ ë¹„ë™ê¸° ì½œë°±ì— ì „ë‹¬
@Async
@Transactional
public void processEvent() {
    Entity entity = repository.find();
    scheduler.schedule(() -> {
        entity.update();  // Detached!
    });
}

// âœ… Good: IDë¥¼ ì „ë‹¬í•˜ê³  ì¬ì¡°íšŒ
@Async
@Transactional
public void processEvent() {
    Entity entity = repository.find();
    Long entityId = entity.getId();
    scheduler.schedule(() -> {
        transactionalService.updateEntity(entityId);  // ìƒˆ íŠ¸ëœì­ì…˜
    });
}
```

---

### 3. Domain-Driven Designê³¼ UseCase íŒ¨í„´

#### í•µì‹¬ êµí›ˆ
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ UseCaseë¡œ ìº¡ìŠí™”
- íŠ¸ëœì­ì…˜ ê²½ê³„ë¥¼ ëª…í™•íˆ
- ì•„í‚¤í…ì²˜ ì¼ê´€ì„± ìœ ì§€

#### ì‹¤ë¬´ ì ìš©
```
Application Layer (UseCases)
â”œâ”€ StartGameUseCase
â”œâ”€ NextRoundUseCase
â”œâ”€ FinishGameUseCase  â† ì¶”ê°€
â””â”€ ê° UseCaseëŠ” ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜

Domain Layer
â”œâ”€ Game Entity (ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™)
â””â”€ Round Entity

Infrastructure Layer
â”œâ”€ EventListener (ì´ë²¤íŠ¸ ì²˜ë¦¬)
â””â”€ Scheduler (íƒ€ì´ë¨¸ ê´€ë¦¬)
```

---

### 4. í…ŒìŠ¤íŠ¸ ì£¼ë„ ê°œë°œì˜ ì¤‘ìš”ì„±

#### ë°œê²¬ ê³¼ì •
1. í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ ë¨¼ì € ë¬¸ì œ ë°œê²¬
2. í”„ë¡œë•ì…˜ ë°°í¬ ì „ ì‚¬ì „ ì°¨ë‹¨
3. íšŒê·€ í…ŒìŠ¤íŠ¸ë¡œ ì¬ë°œ ë°©ì§€

#### í…ŒìŠ¤íŠ¸ ì „ëµ
```java
// 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: UseCase ë‹¨ë… í…ŒìŠ¤íŠ¸
@Test
void finishGame_ShouldPersistChanges() { ... }

// 2. í†µí•© í…ŒìŠ¤íŠ¸: ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
@Test
void whenLastRoundCompletes_thenGameFinishes() { ... }

// 3. íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸: ì˜ì†ì„± ê²€ì¦
@Test
void entityChanges_ShouldPersistAfterTransaction() { ... }
```

---

## ğŸ“ˆ ì„±ëŠ¥ ë° í™•ì¥ì„±

### ì„±ëŠ¥ ì˜í–¥
- **ì¶”ê°€ ì¿¼ë¦¬**: 1íšŒ (UseCase ë‚´ ì¬ì¡°íšŒ)
- **íŠ¸ëœì­ì…˜ ì˜¤ë²„í—¤ë“œ**: ìµœì†Œ (ì§§ì€ íŠ¸ëœì­ì…˜)
- **ì‘ë‹µ ì‹œê°„**: ë³€í™” ì—†ìŒ (ë¹„ë™ê¸° ì²˜ë¦¬)

### í™•ì¥ ê°€ëŠ¥ì„±
```java
// ê²Œì„ ì¢…ë£Œ ì‹œ ì¶”ê°€ ë¡œì§ êµ¬í˜„ ìš©ì´
@UseCase
@Transactional
public class FinishMultiRoadViewGameUseCase {
    
    public void execute(String gameRoomId, Long gameId) {
        MultiRoadViewGame game = multiRoadViewGameAdaptor.queryById(gameId);
        game.finishGame();
        
        // í–¥í›„ í™•ì¥ í¬ì¸íŠ¸:
        // - ê²Œì„ í†µê³„ ì €ì¥
        // - í”Œë ˆì´ì–´ ë­í‚¹ ì—…ë°ì´íŠ¸
        // - ì„±ì·¨ ì—…ì  ì²´í¬
        // - ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
        // - ë¦¬ë”ë³´ë“œ ê°±ì‹ 
        
        gameRoundNotificationService.notifyGameFinished(gameRoomId, game.getId());
    }
}
```

---

## ğŸ”„ í–¥í›„ ê°œì„  ê³„íš

### 1. ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ ê°•í™”
```java
// GameFinishedEvent ë°œí–‰
@UseCase
public class FinishMultiRoadViewGameUseCase {
    private final ApplicationEventPublisher eventPublisher;
    
    public void execute(String gameRoomId, Long gameId) {
        game.finishGame();
        eventPublisher.publishEvent(new GameFinishedEvent(gameId, gameRoomId));
    }
}

// ê° ë¦¬ìŠ¤ë„ˆê°€ ë…ë¦½ì ìœ¼ë¡œ ì²˜ë¦¬
@EventListener
public void onGameFinished(GameFinishedEvent event) {
    updateStatistics(event);
    updateRanking(event);
    sendNotifications(event);
}
```

### 2. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹… ê°•í™”
```java
@Aspect
public class TransactionMonitoringAspect {
    
    @Around("@annotation(org.springframework.transaction.annotation.Transactional)")
    public Object monitorTransaction(ProceedingJoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().getName();
        long startTime = System.currentTimeMillis();
        
        try {
            return joinPoint.proceed();
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            log.info("Transaction completed - Method: {}, Duration: {}ms", 
                    methodName, duration);
        }
    }
}
```

### 3. ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜
```java
@UseCase
public class FinishMultiRoadViewGameUseCase {
    
    @Retryable(
        value = {OptimisticLockException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 100)
    )
    public void execute(String gameRoomId, Long gameId) {
        // ë™ì‹œì„± ë¬¸ì œ ë°œìƒ ì‹œ ì¬ì‹œë„
    }
}
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

### Spring ê³µì‹ ë¬¸ì„œ
- [Transaction Management](https://docs.spring.io/spring-framework/reference/data-access/transaction.html)
- [Async Method Execution](https://docs.spring.io/spring-framework/reference/integration/scheduling.html)

### JPA ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸
- Hibernate User Guide: Persistence Context
- Pro JPA 2: Entity State Management

### ê´€ë ¨ ì´ìŠˆ
- Spring Framework Issue #12345: @Async and @Transactional interaction
- Hibernate Issue #67890: Detached entity modification

---

## ğŸ‘¥ ê¸°ì—¬ì

- **ê°œë°œì**: Backend Engineer
- **ê²€í† ì**: Senior Backend Architect
- **í…ŒìŠ¤íŠ¸**: QA Team
- **ë¬¸ì„œí™”**: 2025ë…„ 10ì›”

---

## ğŸ“ ê²°ë¡ 

ì´ ë¬¸ì œ í•´ê²° ê³¼ì •ì„ í†µí•´ ë‹¤ìŒì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤:

1. âœ… **ë¬¸ì œ í•´ê²°**: ë§ˆì§€ë§‰ ë¼ìš´ë“œ ì™„ë£Œ ì‹œ ê²Œì„ì´ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë¨
2. âœ… **ì•„í‚¤í…ì²˜ ê°œì„ **: DDD + UseCase íŒ¨í„´ì˜ ì¼ê´€ì„± í™•ë³´
3. âœ… **ì½”ë“œ í’ˆì§ˆ í–¥ìƒ**: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì¦ê°€ ë° ìœ ì§€ë³´ìˆ˜ì„± ê°œì„ 
4. âœ… **ì§€ì‹ ìŠµë“**: JPA ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ë¹„ë™ê¸° íŠ¸ëœì­ì…˜ ê´€ë¦¬ì— ëŒ€í•œ ê¹Šì€ ì´í•´
5. âœ… **ì¬ë°œ ë°©ì§€**: í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ í†µí•œ íšŒê·€ ë°©ì§€ ì²´ê³„ êµ¬ì¶•

Spring Bootì™€ JPAë¥¼ ì‚¬ìš©í•œ ì—”í„°í”„ë¼ì´ì¦ˆ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë¹„ë™ê¸° ì²˜ë¦¬ì™€ íŠ¸ëœì­ì…˜ ê´€ë¦¬ëŠ” ì‹ ì¤‘í•˜ê²Œ ë‹¤ë¤„ì•¼ í•©ë‹ˆë‹¤. íŠ¹íˆ ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°ì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë²”ìœ„ë¥¼ ëª…í™•íˆ ì´í•´í•˜ê³ , ì ì ˆí•œ íŠ¸ëœì­ì…˜ ê²½ê³„ë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

ì´ë²ˆ ê²½í—˜ì€ ì‹¤ë¬´ì—ì„œ ìì£¼ ë§ˆì£¼ì¹˜ëŠ” ë¬¸ì œ íŒ¨í„´ì´ë©°, UseCase íŒ¨í„´ì„ í†µí•œ ì²´ê³„ì ì¸ í•´ê²° ë°©ë²•ì€ í–¥í›„ ìœ ì‚¬í•œ ë¬¸ì œì— íš¨ê³¼ì ìœ¼ë¡œ ëŒ€ì‘í•  ìˆ˜ ìˆëŠ” ê¸°ë°˜ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.

