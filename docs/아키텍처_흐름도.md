# 아키텍처 흐름도 (트랜잭션 & 영속성 컨텍스트 문제)

> 이 문서는 그림으로 그릴 수 있도록 상세한 설명과 함께 작성되었습니다.

---

## 1. 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Presentation Layer                           │
│  ┌──────────────────┐        ┌──────────────────┐                  │
│  │  WebSocket       │        │  REST Controller │                  │
│  │  /ws/game/*      │        │  /api/game/*     │                  │
│  └────────┬─────────┘        └────────┬─────────┘                  │
└───────────┼──────────────────────────┼─────────────────────────────┘
            │                          │
            ▼                          ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Application Layer (UseCases)                   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  StartRoadViewSoloRoundUseCase                              │   │
│  │  - 게임 시작                                                 │   │
│  │  - 라운드 1 생성                                             │   │
│  │  - 타이머 시작                                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  NextRoadViewRoundUseCase                                   │   │
│  │  - 다음 라운드 생성                                          │   │
│  │  - 타이머 시작                                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  FinishMultiRoadViewGameUseCase ⭐ (새로 추가)              │   │
│  │  - 게임 종료 처리                                            │   │
│  │  - WebSocket 알림                                            │   │
│  │  - @Transactional 보장                                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  SubmitRoadViewPlayerAnswerUseCase                          │   │
│  │  - 플레이어 답안 제출                                        │   │
│  │  - 조기 종료 체크                                            │   │
│  └─────────────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Event Layer                                 │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  RoundCompletionEventListener (@Async)                       │  │
│  │                                                               │  │
│  │  @EventListener                                               │  │
│  │  ├─ handleEarlyRoundCompletion (조기 종료)                   │  │
│  │  └─ handleRoundCompletion (타이머 만료)                      │  │
│  │                                                               │  │
│  │  처리 흐름:                                                   │  │
│  │  1. 라운드 결과 계산                                         │  │
│  │  2. 결과 브로드캐스트                                        │  │
│  │  3. 전환 타이머 시작 (10초)                                  │  │
│  │  4. 콜백 등록: processNextRound                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Infrastructure Layer                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐  │
│  │ GameTimerService │  │  TaskScheduler   │  │ JPA Repository  │  │
│  │                  │  │                  │  │                 │  │
│  │ - 타이머 관리    │  │ - 스케줄링       │  │ - 영속성 관리   │  │
│  │ - 콜백 실행      │  │ - 콜백 실행      │  │ - 트랜잭션      │  │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
            │                     │                      │
            └─────────────────────┼──────────────────────┘
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Domain Layer                                │
│  ┌────────────────────┐  ┌────────────────────┐                    │
│  │ MultiRoadViewGame  │  │ RoadViewGameRound  │                    │
│  │                    │  │                    │                    │
│  │ - currentRound     │  │ - roundNumber      │                    │
│  │ - totalRounds      │  │ - isFinished       │                    │
│  │ - isFinished ⭐    │  │ - serverStartTime  │                    │
│  │ - finishGame()     │  │                    │                    │
│  └────────────────────┘  └────────────────────┘                    │
└─────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Database (MySQL)                            │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │  multi_road_view_game                                      │    │
│  │  - id                                                       │    │
│  │  - is_finished (BOOLEAN) ⭐ 문제 발생 지점                 │    │
│  │  - current_round                                            │    │
│  │  - total_rounds                                             │    │
│  └────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 문제 발생 시나리오 (Before) - 시퀀스 다이어그램

```
Player         Controller    EventListener    GameTimerService    TaskScheduler    Database
  │                │               │                  │                 │             │
  │ 제출           │               │                  │                 │             │
  │───────────────>│               │                  │                 │             │
  │                │               │                  │                 │             │
  │                │ RoundCompletion                  │                 │             │
  │                │ Event 발행                       │                 │             │
  │                │──────────────>│                  │                 │             │
  │                │               │                  │                 │             │
  │                │               │ @Async 스레드    │                 │             │
  │                │               │ @Transactional   │                 │             │
  │                │               │ 시작 ━━━━━━━━━━━┓                 │             │
  │                │               │                 ┃                 │             │
  │                │               │ ┌──────────────┃─────┐            │             │
  │                │               │ │ game 조회    ┃     │            │             │
  │                │               │ │              ┃     │            │             │
  │                │               │ │ SELECT * FROM┃game │            │             │
  │                │               │─┼──────────────┃────>│            │             │
  │                │               │<┼──────────────┃─────│            │             │
  │                │               │ │ game (managed┃)    │            │             │
  │                │               │ │              ┃     │            │             │
  │                │               │ │ 전환 타이머  ┃     │            │             │
  │                │               │ │ 시작         ┃     │            │             │
  │                │               │─┼──────────────┃────────────────>│             │
  │                │               │ │              ┃     │            │             │
  │                │               │ │ 콜백 등록:   ┃     │   10초 후  │             │
  │                │               │ │ game 객체    ┃     │   실행 예약│             │
  │                │               │ │ 전달 ❌      ┃     │            │             │
  │                │               │ └──────────────┃─────┘            │             │
  │                │               │                ┃                  │             │
  │                │               │ 메서드 리턴    ┃                  │             │
  │                │               │                ┃                  │             │
  │                │               │ @Transactional ┃                  │             │
  │                │               │ 종료 & 커밋    ┃                  │             │
  │                │               │ ━━━━━━━━━━━━━━┛                  │             │
  │                │               │                                   │             │
  │                │               │ 영속성 컨텍스트 종료              │             │
  │                │               │ game → detached 상태              │             │
  │                │               │                                   │             │
  │                │               │ [10초 대기...]                    │             │
  │                │               │                                   │             │
  │                │               │                                   │ 콜백 실행   │
  │                │               │<──────────────────────────────────│             │
  │                │               │                                   │             │
  │                │               │ processNextRound()                │             │
  │                │               │ ├─ game.isLastRound() ✅         │             │
  │                │               │ └─ handleLastRound()              │             │
  │                │               │                                   │             │
  │                │               │    game.finishGame()              │             │
  │                │               │    ├─ isFinished = true (메모리)  │             │
  │                │               │    │  하지만 detached 상태 ❌     │             │
  │                │               │    │                              │             │
  │                │               │    └─ 트랜잭션 없음 ❌            │             │
  │                │               │                                   │             │
  │                │               │                                   │   UPDATE 없음
  │                │               │                                   │   ❌        │
  │                │               │                                   │             │
  │<──────────────────────────────────────────────────────────────────┼─────────────│
  │  게임 상태 조회                                                    │             │
  │                                                                    │  SELECT     │
  │─────────────────────────────────────────────────────────────────────────────────>│
  │<─────────────────────────────────────────────────────────────────────────────────│
  │  is_finished = false ❌                                            │             │
  │  (DB에 저장 안됨)                                                 │             │
```

### 문제 포인트 표시:
1. **❌ 1번 문제**: `game` 엔티티를 콜백에 직접 전달
2. **❌ 2번 문제**: 트랜잭션 종료 후 `game`이 detached 상태
3. **❌ 3번 문제**: 콜백 실행 시 트랜잭션 없음
4. **❌ 4번 문제**: `game.finishGame()` 호출해도 DB 미반영

---

## 3. 해결 후 시나리오 (After) - 시퀀스 다이어그램

```
Player         Controller    EventListener    GameTimerService    UseCase           Database
  │                │               │                  │              │                  │
  │ 제출           │               │                  │              │                  │
  │───────────────>│               │                  │              │                  │
  │                │               │                  │              │                  │
  │                │ RoundCompletion                  │              │                  │
  │                │ Event 발행                       │              │                  │
  │                │──────────────>│                  │              │                  │
  │                │               │                  │              │                  │
  │                │               │ @Async 스레드    │              │                  │
  │                │               │ @Transactional   │              │                  │
  │                │               │ 시작 ━━━━━━━━━━━┓              │                  │
  │                │               │                 ┃              │                  │
  │                │               │ ┌──────────────┃─────┐         │                  │
  │                │               │ │ game 조회    ┃     │         │                  │
  │                │               │ │              ┃     │         │                  │
  │                │               │ │ SELECT * FROM┃game │         │                  │
  │                │               │─┼──────────────┃────────────────────────────────>│
  │                │               │<┼──────────────┃─────────────────────────────────│
  │                │               │ │ game (managed┃)    │         │                  │
  │                │               │ │              ┃     │         │                  │
  │                │               │ │ gameId 추출  ┃     │         │                  │
  │                │               │ │ gameId = game┃.getId() ✅   │                  │
  │                │               │ │              ┃     │         │                  │
  │                │               │ │ 전환 타이머  ┃     │         │                  │
  │                │               │ │ 시작         ┃     │         │                  │
  │                │               │─┼──────────────┃─────────────>│                  │
  │                │               │ │              ┃     │         │                  │
  │                │               │ │ 콜백 등록:   ┃     │  10초 후│                  │
  │                │               │ │ gameId만 전달┃✅   │  실행 예약                 │
  │                │               │ └──────────────┃─────┘         │                  │
  │                │               │                ┃               │                  │
  │                │               │ 메서드 리턴    ┃               │                  │
  │                │               │                ┃               │                  │
  │                │               │ @Transactional ┃               │                  │
  │                │               │ 종료 & 커밋    ┃               │                  │
  │                │               │ ━━━━━━━━━━━━━━┛               │                  │
  │                │               │                                │                  │
  │                │               │ [10초 대기...]                 │                  │
  │                │               │                                │                  │
  │                │               │                                │ 콜백 실행        │
  │                │               │<───────────────────────────────│                  │
  │                │               │                                │                  │
  │                │               │ processNextRound(gameId) ✅   │                  │
  │                │               │ ├─ game 재조회                │                  │
  │                │               │ └─ game.isLastRound()          │                  │
  │                │               │                                │                  │
  │                │               │ FinishGameUseCase.execute()    │                  │
  │                │               │───────────────────────────────>│                  │
  │                │               │                                │                  │
  │                │               │                                │ @Transactional   │
  │                │               │                                │ 시작 ━━━━━━━━━┓ │
  │                │               │                                │                ┃ │
  │                │               │                                │ game 재조회    ┃ │
  │                │               │                                │ SELECT * FROM  ┃ │
  │                │               │                                │ game WHERE id  ┃ │
  │                │               │                                │────────────────┃─>│
  │                │               │                                │<───────────────┃──│
  │                │               │                                │ game (managed) ┃ │
  │                │               │                                │                ┃ │
  │                │               │                                │ game.finishGame() ┃
  │                │               │                                │ isFinished=true┃ │
  │                │               │                                │ ✅             ┃ │
  │                │               │                                │                ┃ │
  │                │               │                                │ 변경 감지      ┃ │
  │                │               │                                │ (Dirty Check)  ┃ │
  │                │               │                                │                ┃ │
  │                │               │                                │ @Transactional ┃ │
  │                │               │                                │ 커밋           ┃ │
  │                │               │                                │                ┃ │
  │                │               │                                │ UPDATE game    ┃ │
  │                │               │                                │ SET is_finished┃ │
  │                │               │                                │ = true ✅      ┃ │
  │                │               │                                │────────────────┃─>│
  │                │               │                                │ ━━━━━━━━━━━━━━┛ │
  │                │               │<───────────────────────────────│                  │
  │                │               │                                │                  │
  │<──────────────────────────────────────────────────────────────────────────────────│
  │  게임 상태 조회                                                │                  │
  │                                                                 │      SELECT      │
  │──────────────────────────────────────────────────────────────────────────────────>│
  │<──────────────────────────────────────────────────────────────────────────────────│
  │  is_finished = true ✅                                          │                  │
  │  (DB에 정상 저장됨)                                            │                  │
```

### 개선 포인트 표시:
1. **✅ 개선 1**: `gameId`만 콜백에 전달
2. **✅ 개선 2**: UseCase에서 새 트랜잭션 시작
3. **✅ 개선 3**: UseCase 내에서 `game` 재조회 (managed 상태)
4. **✅ 개선 4**: 변경 감지로 자동 DB 저장

---

## 4. 트랜잭션 & 스레드 타임라인

```
시간축 ─────────────────────────────────────────────────────────────────>

[시간: 0초] ━━━━━━━━━━━━━━━━━━━━━━ [시간: 10초] ━━━━━━━━━━━━━━━━━━━━>

┌─────────────────────────────────────────────────────────────────────────┐
│                    Async Event Thread                                   │
│  (Spring @Async Thread Pool)                                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  @Transactional 시작 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓                │
│  ┃                                                     ┃                │
│  ┃  [0.1초] game 조회 (SELECT)                        ┃                │
│  ┃  └─> MultiRoadViewGame (managed)                   ┃                │
│  ┃                                                     ┃                │
│  ┃  [0.2초] 라운드 결과 계산                          ┃                │
│  ┃                                                     ┃                │
│  ┃  [0.3초] WebSocket 브로드캐스트                    ┃                │
│  ┃                                                     ┃                │
│  ┃  [0.4초] startTransitionTimer()                    ┃                │
│  ┃  ├─ gameId = game.getId()  ✅ AFTER               ┃                │
│  ┃  ├─ 콜백 등록 (10초 후 실행)                       ┃                │
│  ┃  └─ 즉시 리턴                                      ┃                │
│  ┃                                                     ┃                │
│  ┃  [0.5초] 메서드 종료                               ┃                │
│  ┃                                                     ┃                │
│  @Transactional 커밋 & 종료 ━━━━━━━━━━━━━━━━━━━━━━━━┛                │
│                                                                         │
│  [0.6초] 영속성 컨텍스트 종료                                          │
│  └─> game → detached 상태                                              │
│                                                                         │
│  [0.7초] 스레드 반환 (Thread Pool)                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘

                    [대기 시간: 10초]
                    타이머 카운트다운...

┌─────────────────────────────────────────────────────────────────────────┐
│                TaskScheduler Thread                                     │
│  (Spring TaskScheduler Thread Pool)                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [10.0초] 콜백 실행 시작                                                │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ BEFORE (문제 상황)                                              │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  트랜잭션 없음 ❌                                                │   │
│  │  영속성 컨텍스트 없음 ❌                                        │   │
│  │                                                                 │   │
│  │  [10.1초] processNextRound(gameRoomId, game)                   │   │
│  │  └─> game은 detached 상태 ❌                                   │   │
│  │                                                                 │   │
│  │  [10.2초] game.isLastRound() ✅ (메모리 읽기는 가능)           │   │
│  │                                                                 │   │
│  │  [10.3초] handleLastRound()                                     │   │
│  │  └─> game.finishGame()                                         │   │
│  │      └─> isFinished = true (메모리상으로만 변경)               │   │
│  │                                                                 │   │
│  │  [10.4초] 콜백 종료                                             │   │
│  │  └─> DB 저장 없음 ❌                                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ AFTER (해결 상황)                                               │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  [10.1초] processNextRound(gameRoomId, gameId) ✅              │   │
│  │                                                                 │   │
│  │  [10.2초] game 재조회 (필요 시)                                │   │
│  │                                                                 │   │
│  │  [10.3초] finishMultiRoadViewGameUseCase.execute()             │   │
│  │                                                                 │   │
│  │  @Transactional 시작 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓         │   │
│  │  ┃                                                   ┃         │   │
│  │  ┃  [10.4초] game 재조회 (SELECT)                   ┃         │   │
│  │  ┃  └─> MultiRoadViewGame (managed) ✅              ┃         │   │
│  │  ┃                                                   ┃         │   │
│  │  ┃  [10.5초] game.finishGame()                      ┃         │   │
│  │  ┃  └─> isFinished = true                           ┃         │   │
│  │  ┃                                                   ┃         │   │
│  │  ┃  [10.6초] WebSocket 알림                         ┃         │   │
│  │  ┃                                                   ┃         │   │
│  │  ┃  [10.7초] 트랜잭션 커밋                          ┃         │   │
│  │  ┃  ├─ 변경 감지 (Dirty Check)                     ┃         │   │
│  │  ┃  └─ UPDATE game SET is_finished = true ✅       ┃         │   │
│  │  ┃                                                   ┃         │   │
│  │  @Transactional 종료 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  [10.8초] 스레드 반환                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. JPA 엔티티 상태 전환도

```
┌──────────────────────────────────────────────────────────────────────────┐
│                       JPA Entity Lifecycle                               │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                        ┌─────────────┐                                  │
│                        │  Transient  │                                  │
│                        │  (비영속)   │                                  │
│                        │             │                                  │
│                        │ new Game()  │                                  │
│                        └──────┬──────┘                                  │
│                               │                                          │
│                               │ persist()                                │
│                               │                                          │
│        ┌──────────────────────▼──────────────────────┐                  │
│        │           Managed (영속)                    │                  │
│        │                                              │                  │
│        │  ┌────────────────────────────────────┐    │                  │
│        │  │  Persistence Context (영속성 컨텍스트)  │                  │
│        │  │                                     │    │                  │
│        │  │  ┌──────────────────────────────┐ │    │                  │
│        │  │  │  MultiRoadViewGame           │ │    │                  │
│        │  │  │                               │ │    │                  │
│        │  │  │  - id: 123                    │ │    │                  │
│        │  │  │  - isFinished: false          │ │    │                  │
│        │  │  │  - currentRound: 2            │ │    │                  │
│        │  │  └──────────────────────────────┘ │    │                  │
│        │  │                                     │    │                  │
│        │  │  ✅ 변경 감지 (Dirty Check) 활성화  │    │                  │
│        │  │  ✅ 지연 로딩 가능                   │    │                  │
│        │  │  ✅ 1차 캐시                        │    │                  │
│        │  └────────────────────────────────────┘    │                  │
│        │                                              │                  │
│        │  트랜잭션 범위 내에서만 유지됨               │                  │
│        └────┬──────────────────────────┬──────────────┘                  │
│             │                          │                                 │
│             │ clear()                  │ @Transactional 종료             │
│             │ detach()                 │ 트랜잭션 커밋                   │
│             │                          │                                 │
│             ▼                          ▼                                 │
│    ┌─────────────────┐      ┌─────────────────┐                         │
│    │    Removed      │      │    Detached     │                         │
│    │    (삭제)       │      │    (준영속)     │ ⭐ 문제 발생 지점       │
│    │                 │      │                 │                         │
│    │ remove() 호출   │      │ ❌ 영속성 컨텍스트에서 분리됨            │
│    │                 │      │ ❌ 변경 감지 비활성화                     │
│    └─────────────────┘      │ ❌ 지연 로딩 불가 (LazyInitException)    │
│                              │                 │                         │
│                              │ game.finishGame() 호출                    │
│                              │ └─> isFinished = true (메모리만)          │
│                              │                 │                         │
│                              │ DB 저장 안됨 ❌ │                         │
│                              └─────────────────┘                         │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                 BEFORE vs AFTER 비교                                     │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  BEFORE (문제 상황):                                                     │
│                                                                          │
│  [Async Thread - @Transactional]                                        │
│    game = repository.findById(123)  ───> Managed                        │
│    │                                                                     │
│    │ 콜백 등록 (game 객체 전달) ❌                                       │
│    │                                                                     │
│    @Transactional 종료 ───────────────> Detached                        │
│                                                                          │
│  [TaskScheduler Thread - 10초 후]                                       │
│    game.finishGame()  ───> Detached 상태에서 호출 ❌                    │
│    └─> DB 저장 안됨                                                     │
│                                                                          │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                          │
│  AFTER (해결 상황):                                                      │
│                                                                          │
│  [Async Thread - @Transactional]                                        │
│    game = repository.findById(123)  ───> Managed                        │
│    gameId = game.getId()                                                │
│    │                                                                     │
│    │ 콜백 등록 (gameId만 전달) ✅                                        │
│    │                                                                     │
│    @Transactional 종료                                                  │
│                                                                          │
│  [TaskScheduler Thread - 10초 후]                                       │
│    finishGameUseCase.execute(gameId)  ─┐                               │
│                                         │                                │
│    [@Transactional - UseCase]          │                                │
│      game = repository.findById(gameId) ───> Managed ✅                 │
│      game.finishGame()                                                  │
│      @Transactional 커밋 ───> UPDATE 자동 실행 ✅                       │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 데이터 흐름도 (Data Flow)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    1. 게임 시작 단계                                     │
└─────────────────────────────────────────────────────────────────────────┘

  Client                                                         Database
    │                                                               │
    │ POST /api/game/start                                         │
    │──────────────────────────────────────────────>               │
    │                                                │              │
    │         StartRoadViewSoloRoundUseCase          │              │
    │         @Transactional                         │              │
    │         ├─ MultiRoadViewGame 생성              │              │
    │         │  └─ totalRounds: 5                   │              │
    │         │     currentRound: 1                  │  INSERT     │
    │         │     isFinished: false                │──────────────>│
    │         │                                      │              │
    │         ├─ RoadViewGameRound 생성              │  INSERT     │
    │         │                                      │──────────────>│
    │         │                                      │              │
    │         └─ GameTimerService.startRoundTimer() │              │
    │                                                │              │
    │<──────────────────────────────────────────────               │
    │ 200 OK { gameId: 123, roundId: 1 }                           │

┌─────────────────────────────────────────────────────────────────────────┐
│                    2. 라운드 진행 단계                                   │
└─────────────────────────────────────────────────────────────────────────┘

  Client                                                         Database
    │                                                               │
    │ WS: /submit-answer                                           │
    │──────────────────────────────────────────────>               │
    │                                                │              │
    │         SubmitRoadViewPlayerAnswerUseCase      │              │
    │         ├─ Redis에 답안 저장                  │              │
    │         └─ 조기 종료 체크                     │              │
    │             └─ 모두 제출 완료?                │              │
    │                 └─ EarlyRoundCompletionEvent  │              │
    │                     발행                       │              │

┌─────────────────────────────────────────────────────────────────────────┐
│                    3. 라운드 종료 단계 ⭐                               │
└─────────────────────────────────────────────────────────────────────────┘

  EventBus                EventListener                           Database
    │                          │                                      │
    │ EarlyRoundCompletion     │                                      │
    │ Event                    │                                      │
    │─────────────────────────>│                                      │
    │                          │                                      │
    │                          │ @Async                               │
    │                          │ @Transactional                       │
    │                          │ ┌─────────────────────────┐          │
    │                          │ │ 1. 라운드 결과 계산     │          │
    │                          │ │                         │ SELECT   │
    │                          │ │    game 조회            │─────────>│
    │                          │ │                         │<─────────│
    │                          │ │    round 조회           │ SELECT   │
    │                          │ │                         │─────────>│
    │                          │ │                         │<─────────│
    │                          │ │                         │          │
    │                          │ │ 2. round.finishRound()  │          │
    │                          │ │    isFinished = true    │ UPDATE   │
    │                          │ │                         │─────────>│
    │                          │ │                         │          │
    │                          │ │ 3. gameId 추출 ✅       │          │
    │                          │ │    Long gameId =        │          │
    │                          │ │    game.getId()         │          │
    │                          │ └─────────────────────────┘          │
    │                          │                                      │
    │                          │ @Transactional 커밋                  │
    │                          │                                      │
    │                          │ 4. 전환 타이머 시작                  │
    │                          │    콜백 등록 (gameId 전달)           │
    │                          │                                      │

┌─────────────────────────────────────────────────────────────────────────┐
│                    4. 게임 종료 단계 ⭐ (10초 후)                       │
└─────────────────────────────────────────────────────────────────────────┘

  TaskScheduler          UseCase                                  Database
    │                       │                                         │
    │ 콜백 실행              │                                         │
    │ processNextRound       │                                         │
    │ (gameId)               │                                         │
    │                       │                                         │
    │ finishMultiRoadView   │                                         │
    │ GameUseCase.execute   │                                         │
    │──────────────────────>│                                         │
    │                       │                                         │
    │                       │ @Transactional ┌──────────────────┐    │
    │                       │                │                  │    │
    │                       │                │ 1. game 재조회   │    │
    │                       │                │    (managed)     │ SELECT
    │                       │                │                  │───>│
    │                       │                │                  │<───│
    │                       │                │                  │    │
    │                       │                │ 2. finishGame()  │    │
    │                       │                │    isFinished    │    │
    │                       │                │    = true        │    │
    │                       │                │                  │    │
    │                       │                │ 3. WebSocket알림 │    │
    │                       │                │                  │    │
    │                       │                │ 4. 트랜잭션 커밋 │    │
    │                       │                │    Dirty Check   │ UPDATE
    │                       │                │                  │───>│
    │                       │                └──────────────────┘    │
    │                       │                                         │
    │<──────────────────────│                                         │
    │                                                                 │
    │                                                                 │
    ▼                                                                 │
  Client<─────── WebSocket: game_finished ─────────────────────────  │
```

---

## 7. 레이어별 책임 분리도

```
┌───────────────────────────────────────────────────────────────────────┐
│                      Layer Architecture                               │
├───────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  Presentation Layer                                         │    │
│  │  ────────────────────────────────────────────────────────   │    │
│  │  책임: HTTP 요청/응답, WebSocket 통신                       │    │
│  │                                                              │    │
│  │  ┌────────────────┐  ┌─────────────────────────────────┐   │    │
│  │  │ REST Controller│  │ WebSocket Handler                │   │    │
│  │  │                │  │                                   │   │    │
│  │  │ - /api/game/*  │  │ - /ws/game/*                     │   │    │
│  │  │ - DTO 변환     │  │ - STOMP 메시지 처리              │   │    │
│  │  └────────┬───────┘  └───────────┬─────────────────────┘   │    │
│  └───────────┼──────────────────────┼─────────────────────────┘    │
│              │                      │                               │
│              ▼                      ▼                               │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  Application Layer (UseCases)                               │    │
│  │  ────────────────────────────────────────────────────────   │    │
│  │  책임: 비즈니스 유스케이스, 트랜잭션 관리                  │    │
│  │                                                              │    │
│  │  ┌────────────────────────────────────────────────────┐    │    │
│  │  │ StartRoadViewSoloRoundUseCase                      │    │    │
│  │  │ @Transactional                                     │    │    │
│  │  │ ├─ 게임 생성                                        │    │    │
│  │  │ ├─ 첫 라운드 생성                                   │    │    │
│  │  │ └─ 타이머 시작                                      │    │    │
│  │  └────────────────────────────────────────────────────┘    │    │
│  │                                                              │    │
│  │  ┌────────────────────────────────────────────────────┐    │    │
│  │  │ NextRoadViewRoundUseCase                           │    │    │
│  │  │ @Transactional                                     │    │    │
│  │  │ ├─ 다음 라운드 생성                                 │    │    │
│  │  │ ├─ 게임 상태 업데이트 (currentRound++)            │    │    │
│  │  │ └─ 타이머 시작                                      │    │    │
│  │  └────────────────────────────────────────────────────┘    │    │
│  │                                                              │    │
│  │  ┌────────────────────────────────────────────────────┐    │    │
│  │  │ FinishMultiRoadViewGameUseCase ⭐ NEW              │    │    │
│  │  │ @Transactional ✅ 핵심 해결책                       │    │    │
│  │  │ ├─ 게임 재조회 (managed 상태)                      │    │    │
│  │  │ ├─ game.finishGame() (영속성 컨텍스트 내)         │    │    │
│  │  │ ├─ WebSocket 알림                                  │    │    │
│  │  │ └─ 트랜잭션 커밋 → DB 자동 저장                    │    │    │
│  │  └────────────────────────────────────────────────────┘    │    │
│  │                                                              │    │
│  │  ┌────────────────────────────────────────────────────┐    │    │
│  │  │ EndRoadViewSoloRoundUseCase                        │    │    │
│  │  │ @Transactional                                     │    │    │
│  │  │ ├─ 라운드 종료 처리                                 │    │    │
│  │  │ ├─ 점수 계산                                        │    │    │
│  │  │ └─ 순위 산정                                        │    │    │
│  │  └────────────────────────────────────────────────────┘    │    │
│  └──────────────────────────┬───────────────────────────────────┘    │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  Event Layer                                                │    │
│  │  ────────────────────────────────────────────────────────   │    │
│  │  책임: 이벤트 처리, 비동기 작업 조율                        │    │
│  │                                                              │    │
│  │  ┌────────────────────────────────────────────────────┐    │    │
│  │  │ RoundCompletionEventListener                       │    │    │
│  │  │ @Async @Transactional                              │    │    │
│  │  │                                                     │    │    │
│  │  │ handleRoundCompletion()                            │    │    │
│  │  │ ├─ EndRoundUseCase 호출 (결과 계산)               │    │    │
│  │  │ ├─ WebSocket 결과 브로드캐스트                     │    │    │
│  │  │ ├─ game 조회 → gameId 추출 ✅                     │    │    │
│  │  │ └─ 전환 타이머 시작 (gameId 전달)                 │    │    │
│  │  │                                                     │    │    │
│  │  │ processNextRound(gameId)                           │    │    │
│  │  │ ├─ game.isLastRound() 체크                        │    │    │
│  │  │ ├─ 마지막 라운드면 FinishGameUseCase 호출 ✅      │    │    │
│  │  │ └─ 아니면 NextRoundUseCase 호출                    │    │    │
│  │  └────────────────────────────────────────────────────┘    │    │
│  └──────────────────────────┬───────────────────────────────────┘    │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  Infrastructure Layer                                       │    │
│  │  ────────────────────────────────────────────────────────   │    │
│  │  책임: 기술적 구현, 외부 시스템 연동                        │    │
│  │                                                              │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐  │    │
│  │  │GameTimerSvc  │  │TaskScheduler │  │WebSocketSvc     │  │    │
│  │  │              │  │              │  │                 │  │    │
│  │  │- 타이머 관리 │  │- 콜백 스케줄 │  │- STOMP 메시징   │  │    │
│  │  │- 동기화      │  │- 지연 실행   │  │- 브로드캐스트   │  │    │
│  │  └──────────────┘  └──────────────┘  └─────────────────┘  │    │
│  └──────────────────────────┬───────────────────────────────────┘    │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  Domain Layer                                               │    │
│  │  ────────────────────────────────────────────────────────   │    │
│  │  책임: 핵심 비즈니스 로직, 엔티티, 값 객체                  │    │
│  │                                                              │    │
│  │  ┌────────────────────────────────────────────────────┐    │    │
│  │  │ MultiRoadViewGame (Entity)                         │    │    │
│  │  │                                                     │    │    │
│  │  │ - currentRound: Integer                            │    │    │
│  │  │ - totalRounds: Integer                             │    │    │
│  │  │ - isFinished: Boolean ⭐                           │    │    │
│  │  │                                                     │    │    │
│  │  │ Business Methods:                                  │    │    │
│  │  │ - startGame()                                      │    │    │
│  │  │ - moveToNextRound()                                │    │    │
│  │  │ - finishGame() ⭐                                  │    │    │
│  │  │ - isLastRound(): boolean                           │    │    │
│  │  └────────────────────────────────────────────────────┘    │    │
│  │                                                              │    │
│  │  ┌────────────────────────────────────────────────────┐    │    │
│  │  │ RoadViewGameRound (Entity)                         │    │    │
│  │  │                                                     │    │    │
│  │  │ - roundNumber: Integer                             │    │    │
│  │  │ - isFinished: Boolean                              │    │    │
│  │  │ - serverStartTime: Instant                         │    │    │
│  │  │ - duration: Duration                               │    │    │
│  │  │                                                     │    │    │
│  │  │ - finishRound()                                    │    │    │
│  │  │ - isTimeExpired(): boolean                         │    │    │
│  │  └────────────────────────────────────────────────────┘    │    │
│  └──────────────────────────┬───────────────────────────────────┘    │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  Persistence Layer (JPA Repository)                         │    │
│  │  ────────────────────────────────────────────────────────   │    │
│  │  책임: 데이터 영속성, 트랜잭션 관리                         │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  Database (MySQL)                                           │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 8. 문제 발생 및 해결 비교 플로우차트

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          BEFORE (문제 상황)                             │
└─────────────────────────────────────────────────────────────────────────┘

                        [라운드 종료 이벤트 발생]
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ @Async EventListener     │
                    │ @Transactional 시작      │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ game 조회 (managed)      │
                    │ SELECT * FROM game       │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 라운드 결과 계산          │
                    │ WebSocket 브로드캐스트   │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ startTransitionTimer()   │
                    │ game 객체 전달 ❌        │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 콜백 등록 (10초 후)      │
                    │ 람다: game 캡처 ❌       │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 메서드 리턴               │
                    │ @Transactional 종료      │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 영속성 컨텍스트 종료      │
                    │ game → detached ❌       │
                    └────────────┬─────────────┘
                                  │
                                  │ [10초 대기...]
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ TaskScheduler 콜백 실행  │
                    │ (트랜잭션 없음) ❌       │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ game.isLastRound()?      │
                    │ (메모리 읽기는 가능)     │
                    └────────────┬─────────────┘
                                  │ YES
                                  ▼
                    ┌──────────────────────────┐
                    │ game.finishGame()        │
                    │ isFinished = true        │
                    │ (메모리만 변경) ❌       │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ WebSocket 알림            │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 콜백 종료                 │
                    │ UPDATE 없음 ❌           │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ DB 상태:                  │
                    │ is_finished = false ❌   │
                    └──────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                          AFTER (해결 상황)                              │
└─────────────────────────────────────────────────────────────────────────┘

                        [라운드 종료 이벤트 발생]
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ @Async EventListener     │
                    │ @Transactional 시작      │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ game 조회 (managed)      │
                    │ SELECT * FROM game       │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 라운드 결과 계산          │
                    │ WebSocket 브로드캐스트   │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ gameId 추출 ✅           │
                    │ Long id = game.getId()   │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ startTransitionTimer()   │
                    │ gameId 전달 ✅           │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 콜백 등록 (10초 후)      │
                    │ 람다: gameId만 캡처 ✅   │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 메서드 리턴               │
                    │ @Transactional 종료      │
                    └────────────┬─────────────┘
                                  │
                                  │ [10초 대기...]
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ TaskScheduler 콜백 실행  │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ game 재조회 (필요시)     │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ game.isLastRound()?      │
                    └────────────┬─────────────┘
                                  │ YES
                                  ▼
                    ┌──────────────────────────┐
                    │ FinishGameUseCase        │
                    │ .execute(gameId) ✅      │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ @Transactional 시작 ✅  │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ game 재조회 (managed) ✅│
                    │ SELECT * FROM game       │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ game.finishGame()        │
                    │ isFinished = true        │
                    │ (managed 상태) ✅        │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ WebSocket 알림            │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ @Transactional 커밋 ✅  │
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ 변경 감지 (Dirty Check)  │
                    │ UPDATE game              │
                    │ SET is_finished = true ✅│
                    └────────────┬─────────────┘
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │ DB 상태:                  │
                    │ is_finished = true ✅    │
                    └──────────────────────────┘
```

---

## 9. 핵심 개념 다이어그램

### 9.1 트랜잭션 경계

```
┌─────────────────────────────────────────────────────────────────┐
│                     Transaction Boundary                        │
└─────────────────────────────────────────────────────────────────┘

BEFORE (문제):
┌────────────────────────────────────────┐
│ @Transactional (EventListener)         │
│ ┌────────────────────────────────────┐ │
│ │ game 조회                          │ │
│ │ ↓                                   │ │
│ │ 콜백 등록 (game 전달)              │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘
         트랜잭션 종료
         game → detached

[10초 후]
┌────────────────────────────────────────┐
│ 트랜잭션 없음 ❌                        │
│ ┌────────────────────────────────────┐ │
│ │ game.finishGame()                  │ │
│ │ (detached 상태)                    │ │
│ │ DB 저장 안됨 ❌                     │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘


AFTER (해결):
┌────────────────────────────────────────┐
│ @Transactional (EventListener)         │
│ ┌────────────────────────────────────┐ │
│ │ game 조회                          │ │
│ │ ↓                                   │ │
│ │ gameId 추출                        │ │
│ │ ↓                                   │ │
│ │ 콜백 등록 (gameId만 전달) ✅       │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘
         트랜잭션 종료

[10초 후]
┌────────────────────────────────────────┐
│ @Transactional (UseCase) ✅            │
│ ┌────────────────────────────────────┐ │
│ │ game 재조회 (managed) ✅           │ │
│ │ ↓                                   │ │
│ │ game.finishGame()                  │ │
│ │ ↓                                   │ │
│ │ 트랜잭션 커밋                      │ │
│ │ ↓                                   │ │
│ │ UPDATE (자동) ✅                   │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘
```

### 9.2 영속성 컨텍스트 생명주기

```
Time ──────────────────────────────────────────────>

┌──────────────────────────────────────────────────┐
│          Persistence Context Lifecycle           │
└──────────────────────────────────────────────────┘

[T1: 0초]  @Transactional 시작
           ┌─────────────────────────────────┐
           │ Persistence Context 생성        │
           │                                  │
           │  ┌───────────────────────┐      │
           │  │ MultiRoadViewGame     │      │
           │  │ (managed)             │      │
           │  │ - id: 123             │      │
           │  │ - isFinished: false   │      │
           │  └───────────────────────┘      │
           └─────────────────────────────────┘

[T2: 0.5초] @Transactional 종료
           ┌─────────────────────────────────┐
           │ Persistence Context 종료        │
           │                                  │
           │  ┌───────────────────────────┐  │
           │  │ MultiRoadViewGame         │  │
           │  │ (detached) ❌             │  │
           │  │                           │  │
           │  │ 영속성 컨텍스트 없음       │  │
           │  │ 변경 감지 불가            │  │
           │  └───────────────────────────┘  │
           └─────────────────────────────────┘

[T3: 10초]  UseCase @Transactional 시작 ✅
           ┌─────────────────────────────────┐
           │ NEW Persistence Context 생성    │
           │                                  │
           │  ┌───────────────────────┐      │
           │  │ MultiRoadViewGame     │      │
           │  │ (managed) ✅          │      │
           │  │ - id: 123             │      │
           │  │ - isFinished: false   │      │
           │  └───────────────────────┘      │
           │                                  │
           │  game.finishGame() 호출          │
           │  └─> isFinished = true          │
           │                                  │
           └─────────────────────────────────┘

[T4: 10.5초] UseCase @Transactional 커밋
            ┌─────────────────────────────────┐
            │ Dirty Check 실행                │
            │                                  │
            │ UPDATE multi_road_view_game     │
            │ SET is_finished = true          │
            │ WHERE id = 123                  │
            │                                  │
            │ ✅ DB 저장 성공                 │
            └─────────────────────────────────┘
```

---

## 10. 구현 체크리스트 (그림 그릴 때 참고)

### 색상 및 스타일 가이드

```
┌────────────────────────────────────────────────────────────┐
│                  Visual Style Guide                        │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ✅ 정상 동작: 초록색 (#4CAF50)                            │
│  ❌ 문제 발생: 빨간색 (#F44336)                           │
│  ⭐ 핵심 포인트: 노란색 (#FFC107)                         │
│  🔧 개선사항: 파란색 (#2196F3)                            │
│                                                            │
│  ━━━ 트랜잭션 경계: 굵은 실선                             │
│  ─ ─ 비동기 호출: 점선                                    │
│  ───> 동기 호출: 실선 화살표                              │
│  ═══> 데이터 흐름: 이중 실선 화살표                       │
│                                                            │
│  📦 레이어: 사각형 (모서리 둥글게)                        │
│  🔄 프로세스: 육각형                                       │
│  💾 데이터베이스: 원통형                                   │
│  👤 액터: 스틱 피겨                                        │
│  📢 이벤트: 구름 모양                                      │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 다이어그램별 우선순위

```
1. 필수 다이어그램 (포트폴리오 메인):
   ✓ 전체 시스템 아키텍처 (다이어그램 1)
   ✓ 문제 발생 시퀀스 (다이어그램 2)
   ✓ 해결 후 시퀀스 (다이어그램 3)
   ✓ 엔티티 상태 전환도 (다이어그램 5)

2. 보조 다이어그램:
   ✓ 트랜잭션 타임라인 (다이어그램 4)
   ✓ 데이터 흐름도 (다이어그램 6)
   ✓ 비교 플로우차트 (다이어그램 8)

3. 선택 다이어그램:
   ✓ 레이어별 책임 분리도 (다이어그램 7)
   ✓ 핵심 개념 다이어그램 (다이어그램 9)
```

### 주요 강조 포인트

```
그림 그릴 때 반드시 표시할 것:

1. ❌ 문제 지점
   - Detached 엔티티
   - 트랜잭션 없음
   - DB 저장 실패

2. ✅ 해결 포인트
   - UseCase 추가
   - @Transactional 보장
   - 새 영속성 컨텍스트
   - DB 저장 성공

3. ⭐ 핵심 변경사항
   - game 객체 → gameId 전달
   - 콜백 내 재조회
   - 트랜잭션 분리

4. 🔧 아키텍처 개선
   - DDD 패턴 준수
   - UseCase 일관성
   - 책임 분리
```

---

## 참고사항

이 문서의 다이어그램들은 다음 도구로 그릴 수 있습니다:
- **Draw.io**: 무료, 브라우저 기반
- **Lucidchart**: 전문적, 협업 기능
- **Figma**: 디자인 중심
- **PlantUML**: 코드 기반 (자동 생성)
- **Mermaid**: 마크다운 통합

포트폴리오 발표 시 순서:
1. 전체 아키텍처 소개 (다이어그램 1)
2. 문제 상황 설명 (다이어그램 2, 8 BEFORE)
3. 원인 분석 (다이어그램 4, 5)
4. 해결 방안 (다이어그램 3, 8 AFTER)
5. 결과 및 개선사항

