# KoSpot 시스템 아키텍처 다이어그램

## 전체 시스템 아키텍처

```mermaid
graph TB
    subgraph "Client Layer"
        Browser[웹 브라우저]
    end
    
    subgraph "AWS Cloud"
        subgraph "EC2 Instance"
            Nginx[Nginx<br/>리버스 프록시]
            
            subgraph "Docker Network"
                App[Spring Boot App<br/>Port 8080]
                Redis[Redis<br/>Port 6379]
            end
        end
        
        RDS[(RDS MySQL<br/>데이터베이스)]
        S3[(S3 Bucket<br/>이미지 저장)]
    end
    
    subgraph "External Services"
        Google[Google OAuth]
        Naver[Naver OAuth]
        Kakao[Kakao OAuth]
    end
    
    Browser -->|HTTP/HTTPS| Nginx
    Browser -->|WebSocket| Nginx
    Nginx -->|Reverse Proxy| App
    App -->|JDBC| RDS
    App -->|Redis Client| Redis
    App -->|S3 SDK| S3
    App -->|OAuth2| Google
    App -->|OAuth2| Naver
    App -->|OAuth2| Kakao
```

## 계층형 아키텍처 구조

```mermaid
graph TB
    subgraph "Presentation Layer"
        REST[REST Controller]
        WS[WebSocket Controller]
    end
    
    subgraph "Application Layer"
        UC1[UseCase 1]
        UC2[UseCase 2]
        UC3[UseCase N]
    end
    
    subgraph "Domain Layer"
        Entity1[Entity 1]
        Entity2[Entity 2]
        DS[Domain Service]
    end
    
    subgraph "Infrastructure Layer"
        Repo[JPA Repository]
        RedisSvc[Redis Service]
        S3Svc[S3 Service]
        WSSvc[WebSocket Service]
    end
    
    REST --> UC1
    WS --> UC2
    UC1 --> Entity1
    UC2 --> Entity2
    UC1 --> DS
    UC2 --> DS
    DS --> Repo
    DS --> RedisSvc
    UC3 --> S3Svc
    UC2 --> WSSvc
```

## 멀티플레이어 게임 플로우

```mermaid
stateDiagram-v2
    [*] --> WAITING: 방 생성
    WAITING --> COUNTDOWN: 호스트 게임 시작
    COUNTDOWN --> LOADING: 3초 후
    LOADING --> INTRO: 모든 플레이어 로딩 완료
    LOADING --> WAITING: 타임아웃 (미로딩 플레이어 제외)
    INTRO --> IN_ROUND: 5초 후
    IN_ROUND --> ROUND_END: 타이머 만료 또는 모든 제출
    ROUND_END --> TRANSITION: 결과 표시
    TRANSITION --> IN_ROUND: 다음 라운드
    TRANSITION --> FINISHED: 마지막 라운드
    FINISHED --> [*]: 게임 종료
```

## WebSocket 채널 구조

```mermaid
graph LR
    subgraph "Global Channels"
        Lobby[/topic/lobby]
    end
    
    subgraph "Room Channels"
        Chat[/topic/room/roomId/chat]
        PlayerList[/topic/room/roomId/playerList]
        Status[/topic/room/roomId/status]
        Countdown[/topic/room/roomId/countdown]
    end
    
    subgraph "Game Channels"
        Timer[/topic/room/roomId/game/gameId/timer]
        Result[/topic/room/roomId/game/gameId/round/roundId/result]
        Transition[/topic/room/roomId/game/gameId/round/roundId/transition]
    end
    
    Client[클라이언트] --> Lobby
    Client --> Chat
    Client --> PlayerList
    Client --> Status
    Client --> Countdown
    Client --> Timer
    Client --> Result
    Client --> Transition
```

## 배포 아키텍처

```mermaid
graph TB
    subgraph "GitHub"
        Repo[Repository]
        Actions[GitHub Actions]
    end
    
    subgraph "AWS"
        S3Deploy[(S3 Deploy Bucket)]
        CodeDeploy[CodeDeploy]
        
        subgraph "EC2"
            Docker[Docker Engine]
            AppContainer[App Container]
            RedisContainer[Redis Container]
        end
        
        RDS[(RDS MySQL)]
        S3Images[(S3 Images Bucket)]
    end
    
    Repo -->|Push| Actions
    Actions -->|Build & Upload| S3Deploy
    S3Deploy -->|Deploy| CodeDeploy
    CodeDeploy -->|Deploy| Docker
    Docker --> AppContainer
    Docker --> RedisContainer
    AppContainer --> RDS
    AppContainer --> S3Images
    AppContainer --> RedisContainer
```

## 데이터 흐름도

```mermaid
sequenceDiagram
    participant C as Client
    participant P as Presentation
    participant A as Application
    participant D as Domain
    participant I as Infrastructure
    participant DB as Database
    participant R as Redis
    
    C->>P: HTTP Request
    P->>A: UseCase 호출
    A->>D: Domain Service 호출
    D->>I: Repository 호출
    I->>DB: Query 실행
    DB-->>I: Result
    I-->>D: Entity
    D-->>A: Domain Object
    A->>R: 상태 저장
    A-->>P: Result
    P-->>C: HTTP Response
    
    Note over C,R: WebSocket 통신
    C->>P: WebSocket Message
    P->>A: UseCase 호출
    A->>R: 상태 업데이트
    A->>I: 메시지 브로드캐스트
    I-->>C: WebSocket Broadcast
```

## 게임 상태 관리 (Redis)

```mermaid
graph TB
    subgraph "Redis Data Structures"
        RoomState[room:roomId:state<br/>String]
        Players[room:roomId:players<br/>Hash]
        Loading[room:roomId:player_loading_status<br/>Hash]
        Submissions[round:roundId:submissions<br/>Hash]
        Counter[round:roundId:submission_count<br/>Counter]
    end
    
    subgraph "Operations"
        Read[읽기]
        Write[쓰기]
        PubSub[Pub/Sub]
    end
    
    RoomState --> Read
    Players --> Read
    Players --> Write
    Loading --> Write
    Submissions --> Write
    Counter --> Write
    Counter --> PubSub
```

## CI/CD 파이프라인

```mermaid
graph LR
    A[코드 푸시] --> B[GitHub Actions 트리거]
    B --> C[테스트 실행]
    C --> D[빌드]
    D --> E[Docker 이미지 생성]
    E --> F[S3 업로드]
    F --> G[CodeDeploy 시작]
    G --> H[EC2 배포]
    H --> I[Before Install]
    I --> J[After Install]
    J --> K[Application Start]
    K --> L[Validate Service]
    L --> M{성공?}
    M -->|Yes| N[배포 완료]
    M -->|No| O[롤백]
```

